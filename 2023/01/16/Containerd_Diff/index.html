<!DOCTYPE html>
<html lang='zh-CN'>

<head>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="hexo-theme" content="https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5">
  <meta charset="utf-8">
  

  <meta http-equiv='x-dns-prefetch-control' content='on' />
  <link rel='dns-prefetch' href='https://gcore.jsdelivr.net'>
  <link rel="preconnect" href="https://gcore.jsdelivr.net" crossorigin>
  <link rel='dns-prefetch' href='//unpkg.com'>

  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="theme-color" content="#f8f8f8">
  
  <title>Containerd Diff 服务 - 知识库</title>

  
    <meta name="description" content="概述本文主要为从代码层面分析 Containerd diff 服务模块的实现逻辑，如下图 containerd 架构图所示：   Containerd diff 服务模块，实现了 diff 和 apply 两个主要的服务管理功能   :   Diff 服务计算所提供的上层&#x2F;下层 mount 目录的差异，遵从 OCI 规范 Changesets (变化集)打包 tar diff 镜像层存储">
<meta property="og:type" content="article">
<meta property="og:title" content="Containerd Diff 服务">
<meta property="og:url" content="http://example.com/2023/01/16/Containerd_Diff/index.html">
<meta property="og:site_name" content="知识库">
<meta property="og:description" content="概述本文主要为从代码层面分析 Containerd diff 服务模块的实现逻辑，如下图 containerd 架构图所示：   Containerd diff 服务模块，实现了 diff 和 apply 两个主要的服务管理功能   :   Diff 服务计算所提供的上层&#x2F;下层 mount 目录的差异，遵从 OCI 规范 Changesets (变化集)打包 tar diff 镜像层存储">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/assets/wiki/photos/containerd-diff.png">
<meta property="article:published_time" content="2023-01-16T03:42:20.225Z">
<meta property="article:modified_time" content="2023-01-16T03:42:20.225Z">
<meta property="article:author" content="YuChang Yang">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="containerd">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/assets/wiki/photos/containerd-diff.png">
  
  

  <!-- feed -->
  

  
    
<link rel="stylesheet" href="/css/main.css">

  

  
    <link rel="shortcut icon" href="/assets/knowledge.png">
  

  

  


  
</head>

<body>
  

<div class="l_cover post"><div class="cover"><div class="lazy img bg" data-bg="/assets/wiki/photos/newyear01.jpg"></div></div></div>


  <div class='l_body' id='start'>
    <aside class='l_left' layout='post'>
    

  

<header class="header"><div class="logo-wrap"><a class="avatar" href="/"><div class="bg" style="opacity:0;background-image:url(https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/avatar/round/rainbow64@3x.webp);"></div><img no-lazy class="avatar" src="/assets/logo.svg" onerror="javascript:this.classList.add('error');this.src='https://gcore.jsdelivr.net/gh/cdn-x/placeholder@1.0.4/image/2659360.svg';"></a><a class="title" href="/"><div class="main" ff="title">知识库</div><div class="sub normal cap">建立团队内部知识分享</div><div class="sub hover cap" style="opacity:0"> 统一团队问题管理机制</div></a></div>

<nav class="menu dis-select"><a class="nav-item active" href="/">技术分享</a><a class="nav-item" href="/wiki/">问题汇总</a></nav>
</header>


<div class="widgets">
<widget class="widget-wrapper search"><div class="widget-body"><div class="search-wrapper" id="search"><form class="search-form"><input type="text" class="search-input" id="search-input" data-filter="/blog/" placeholder="文章搜索"><svg t="1670596976048" class="icon search-icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2676" width="200" height="200"><path d="M938.2 832.6L723.8 618.1c-2.5-2.5-5.3-4.4-7.9-6.4 36.2-55.6 57.3-121.8 57.3-193.1C773.3 222.8 614.6 64 418.7 64S64 222.8 64 418.6c0 195.9 158.8 354.6 354.6 354.6 71.3 0 137.5-21.2 193.2-57.4 2 2.7 3.9 5.4 6.3 7.8L832.5 938c14.6 14.6 33.7 21.9 52.8 21.9 19.1 0 38.2-7.3 52.8-21.8 29.2-29.1 29.2-76.4 0.1-105.5M418.7 661.3C284.9 661.3 176 552.4 176 418.6 176 284.9 284.9 176 418.7 176c133.8 0 242.6 108.9 242.6 242.7 0 133.7-108.9 242.6-242.6 242.6" p-id="2677"></path></svg></form><div id="search-result"></div><div class="search-no-result">没有找到内容！</div></div></div></widget>


<widget class="widget-wrapper toc single" id="data-toc"><div class="widget-header cap dis-select"><span class="name">Containerd Diff 服务</span></div><div class="widget-body fs14"><div class="doc-tree active"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Diff-%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E9%93%BE%E5%85%B3%E7%B3%BB"><span class="toc-text">Diff 服务注册链关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Diff-gRPC-Service-%E5%92%8C-local-diff-%E5%AE%9E%E7%8E%B0"><span class="toc-text">Diff gRPC Service 和 local diff 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Comparer-%E6%8E%A5%E5%8F%A3%E5%92%8C-walking-%E5%AE%9E%E7%8E%B0"><span class="toc-text">Comparer 接口和 walking 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Applier-%E6%8E%A5%E5%8F%A3%E5%92%8C-fsApplier-%E5%BA%94%E7%94%A8%E5%AE%9E%E7%8E%B0"><span class="toc-text">Applier 接口和 fsApplier 应用实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Snapshot-diff-%E5%BA%94%E7%94%A8"><span class="toc-text">Snapshot diff 应用</span></a></li></ol></div></div></widget>




</div>
<footer class="footer dis-select"><div class="social-wrap"><a class="social" href="https://github.com/gotoolkits" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/github.svg" /></a><a class="social" href="https://mail.163.com" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/mail.svg" /></a><a class="social" href="https://www.jianshu.com/u/0611daf62bd3" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/datas.svg" /></a><a class="social" href="https://www.jianshu.com/u/0611daf62bd3" target="_blank" rel="external nofollow noopener noreferrer"><img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/jianshu.svg" /></a></div></footer>

    </aside>
    <div class='l_main'>
      

      


<div class="bread-nav fs12"><div id="breadcrumb"><a class="cap breadcrumb" href="/">主页</a><span class="sep"></span><a class="cap breadcrumb" href="/">文章</a><span class="sep"></span><a class="cap breadcrumb-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/">技术文档</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">docker源码分析</a> <span class="sep"></span> <a class="cap breadcrumb-link" href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E6%A1%A3/docker%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Containerd/">Containerd</a></div><div id="post-meta">发布于&nbsp;<time datetime="2023-01-16T03:42:20.225Z">2023-01-16</time></div></div>

<article class='md-text content post'>
<h1 class="article-title"><span>Containerd Diff 服务</span></h1>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>本文主要为从代码层面分析 Containerd diff 服务模块的实现逻辑，如下图 containerd 架构图所示：</p>
<img class="lazy" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAABGdBTUEAALGPC/xhBQAAADhlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAAqACAAQAAAABAAAAAaADAAQAAAABAAAAAQAAAADa6r/EAAAAC0lEQVQIHWNgAAIAAAUAAY27m/MAAAAASUVORK5CYII=" data-src="/assets/wiki/photos/containerd-diff.png" alt="image-20190910153051989" style="zoom:50%;" />

<p>Containerd diff 服务模块，实现了 diff 和 apply 两个主要的服务管理功能   : </p>
<ul>
<li><p>Diff 服务计算所提供的上层&#x2F;下层 mount 目录的差异，遵从 OCI 规范 Changesets (变化集)打包 tar diff 镜像层存储。</p>
</li>
<li><p>Apply 服务将所指定描述器( ocispec.Descriptor )的参照内容应用至指定的挂载目录。通常情况下，描述器指向一个 tar 格式的文件系统差异，此差异文件系统 tar 将被应用于挂载点的顶层。</p>
</li>
</ul>
<p>简单点描述为 “ <strong>Diff 功能实现 diff layer 生成 ,  Apply 功能实现 diff layer 挂载</strong> “。</p>
<p>Containerd 被设计为一个类似微服务的架构, 针对各个组件都提供了 gRPC 接口来进行访问。Containerd 各组件以插件机制来组织管理，本文 diff 的服务将从插件注册开始展开。</p>
<h2 id="Diff-服务注册链关系"><a href="#Diff-服务注册链关系" class="headerlink" title="Diff 服务注册链关系"></a>Diff 服务注册链关系</h2><p>上层 GRPC Plugin 注册 diff , 获取已注册 Diff 服务插件列表，返回 Diff RPC 服务实现类 service{} 对象</p>
<p>services&#x2F;diff&#x2F;service.go:29</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	plugin.Register(&amp;plugin.Registration&#123;</span><br><span class="line">		Type: plugin.GRPCPlugin,</span><br><span class="line">		ID:   <span class="string">&quot;diff&quot;</span>,</span><br><span class="line">		Requires: []plugin.Type&#123;</span><br><span class="line">			plugin.ServicePlugin,</span><br><span class="line">		&#125;,</span><br><span class="line">		InitFn: <span class="function"><span class="keyword">func</span><span class="params">(ic *plugin.InitContext)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">			plugins, err := ic.GetByType(plugin.ServicePlugin)  <span class="comment">// 获取所有服务插件 </span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			p, ok := plugins[services.DiffService]              <span class="comment">// 获取 diff 服务插件</span></span><br><span class="line">			<span class="keyword">if</span> !ok &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, errors.New(<span class="string">&quot;diff service not found&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			i, err := p.Instance()                           <span class="comment">// 返回 diff 服务插件 initFn 的实例化对象</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> &amp;service&#123;local: i.(diffapi.DiffClient)&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Service Plugin 服务插件 diff 服务注册，返回 Local{} 服务实现类对象</p>
<p>services&#x2F;diff&#x2F;local.go:49</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	plugin.Register(&amp;plugin.Registration&#123;</span><br><span class="line">		Type: plugin.ServicePlugin,</span><br><span class="line">		ID:   services.DiffService,</span><br><span class="line">		Requires: []plugin.Type&#123;</span><br><span class="line">			plugin.DiffPlugin,</span><br><span class="line">		&#125;,</span><br><span class="line">		Config: defaultDifferConfig,    <span class="comment">// unix 默认 Order: []string&#123;&quot;walking&quot;&#125;</span></span><br><span class="line">		InitFn: <span class="function"><span class="keyword">func</span><span class="params">(ic *plugin.InitContext)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">			differs, err := ic.GetByType(plugin.DiffPlugin)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			orderedNames := ic.Config.(*config).Order</span><br><span class="line">			ordered := <span class="built_in">make</span>([]differ, <span class="built_in">len</span>(orderedNames))</span><br><span class="line">			<span class="keyword">for</span> i, n := <span class="keyword">range</span> orderedNames &#123;</span><br><span class="line">				differp, ok := differs[n]</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;needed differ not loaded: %s&quot;</span>, n)</span><br><span class="line">				&#125;</span><br><span class="line">				d, err := differp.Instance()</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, errors.Wrapf(err, <span class="string">&quot;could not load required differ due plugin init error: %s&quot;</span>, n)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				ordered[i], ok = d.(differ)</span><br><span class="line">				<span class="keyword">if</span> !ok &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span>, errors.Errorf(<span class="string">&quot;differ does not implement Comparer and Applier interface: %s&quot;</span>, n)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> &amp;local&#123;         <span class="comment">// 返回服务实现类 local&#123;&#125; 实例,即上层 RPC 注册时 p.Instance()</span></span><br><span class="line">				differs: ordered,    <span class="comment">// 指定了 differs 对象列表，底层实现 differ 接口方法 （walking）</span></span><br><span class="line">			&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>底层实现类插件 Diff Plugin 注册 “walking” , 返回实例 diffPlugin{} 实现类对象 </p>
<p>diff&#x2F;walking&#x2F;plugin&#x2F;plugin.go:28</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	plugin.Register(&amp;plugin.Registration&#123;</span><br><span class="line">		Type: plugin.DiffPlugin,</span><br><span class="line">		ID:   <span class="string">&quot;walking&quot;</span>,</span><br><span class="line">		Requires: []plugin.Type&#123;</span><br><span class="line">			plugin.MetadataPlugin,</span><br><span class="line">		&#125;,</span><br><span class="line">		InitFn: <span class="function"><span class="keyword">func</span><span class="params">(ic *plugin.InitContext)</span></span> (<span class="keyword">interface</span>&#123;&#125;, <span class="type">error</span>) &#123;</span><br><span class="line">			md, err := ic.Get(plugin.MetadataPlugin)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			ic.Meta.Platforms = <span class="built_in">append</span>(ic.Meta.Platforms, platforms.DefaultSpec())</span><br><span class="line">      <span class="comment">// 创建 metadata.DB 类型内容存储库，作为后面插件传入参数，用于保存 diff layer 元数据项。</span></span><br><span class="line">			cs := md.(*metadata.DB).ContentStore()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> diffPlugin&#123;</span><br><span class="line">				Comparer: walking.NewWalkingDiff(cs),         <span class="comment">// 差异比对器操作对象</span></span><br><span class="line">				Applier:  apply.NewFileSystemApplier(cs),     <span class="comment">// 文件系统应用器操作对象</span></span><br><span class="line">			&#125;, <span class="literal">nil</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Diff-gRPC-Service-和-local-diff-实现"><a href="#Diff-gRPC-Service-和-local-diff-实现" class="headerlink" title="Diff gRPC Service 和 local diff 实现"></a>Diff gRPC Service 和 local diff 实现</h2><p>前面 diff 服务插件注册时返回为 local{} 类对象，与此同时 diff 服务提供了下面两个方法 Apply() 、Diff()。而 service.local 属性为 diffapi.DiffClient 类型，代表diff client GRPC 请求来实现功能调用。而 diff 服务插件的注册时返回的实现了 diff 服务的类对象则是 local{} ，所有 s.local.Diff 的调用即是 local 类的 Diff 方法。此处应该注意 s.local 的 local 是一个 client 接口，而实现类也是一个同名的 local 类。</p>
<p>services&#x2F;diff&#x2F;service.go:65</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span></span> Apply(ctx context.Context, er *diffapi.ApplyRequest) (*diffapi.ApplyResponse, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> s.local.Apply(ctx, er)      <span class="comment">// RPC 请求 &quot;/containerd.services.diff.v1.Diff/Apply&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *service)</span></span> Diff(ctx context.Context, dr *diffapi.DiffRequest) (*diffapi.DiffResponse, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> s.local.Diff(ctx, dr)      <span class="comment">// RPC 请求 &quot;/containerd.services.diff.v1.Diff/Diff&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>local.Apply</strong> </p>
<p>services&#x2F;diff&#x2F;local.go:94</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *local)</span></span> Apply(ctx context.Context, er *diffapi.ApplyRequest, _ ...grpc.CallOption) (*diffapi.ApplyResponse, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		ocidesc ocispec.Descriptor</span><br><span class="line">		err     <span class="type">error</span></span><br><span class="line">		desc    = toDescriptor(er.Diff)</span><br><span class="line">		mounts  = toMounts(er.Mounts)</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> opts []diff.ApplyOpt</span><br><span class="line">	<span class="keyword">if</span> er.Payloads != <span class="literal">nil</span> &#123;</span><br><span class="line">		opts = <span class="built_in">append</span>(opts, diff.WithPayloads(er.Payloads))</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// differ 应用调用</span></span><br><span class="line">	<span class="keyword">for</span> _, differ := <span class="keyword">range</span> l.differs &#123;</span><br><span class="line">		ocidesc, err = differ.Apply(ctx, desc, mounts, opts...)</span><br><span class="line">		<span class="keyword">if</span> !errdefs.IsNotImplemented(err) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errdefs.ToGRPC(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// grpc响应,应用返回的 ocidesc.Descriptor </span></span><br><span class="line">	<span class="keyword">return</span> &amp;diffapi.ApplyResponse&#123;</span><br><span class="line">		Applied: fromDescriptor(ocidesc),</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>local.Diff</strong>  </p>
<p>services&#x2F;diff&#x2F;local.go:124</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *local)</span></span> Diff(ctx context.Context, dr *diffapi.DiffRequest, _ ...grpc.CallOption) (*diffapi.DiffResponse, <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		ocidesc ocispec.Descriptor</span><br><span class="line">		err     <span class="type">error</span></span><br><span class="line">		aMounts = toMounts(dr.Left)</span><br><span class="line">		bMounts = toMounts(dr.Right)</span><br><span class="line">	)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 参数配置</span></span><br><span class="line">	<span class="keyword">var</span> opts []diff.Opt</span><br><span class="line">	<span class="keyword">if</span> dr.MediaType != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		opts = <span class="built_in">append</span>(opts, diff.WithMediaType(dr.MediaType))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> dr.Ref != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		opts = <span class="built_in">append</span>(opts, diff.WithReference(dr.Ref))</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> dr.Labels != <span class="literal">nil</span> &#123;</span><br><span class="line">		opts = <span class="built_in">append</span>(opts, diff.WithLabels(dr.Labels))</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// differ 差异比较调用</span></span><br><span class="line">	<span class="keyword">for</span> _, d := <span class="keyword">range</span> l.differs &#123;</span><br><span class="line">		ocidesc, err = d.Compare(ctx, aMounts, bMounts, opts...)</span><br><span class="line">		<span class="keyword">if</span> !errdefs.IsNotImplemented(err) &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, errdefs.ToGRPC(err)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// grpc响应,应用返回的 ocidesc.Descriptor </span></span><br><span class="line">	<span class="keyword">return</span> &amp;diffapi.DiffResponse&#123;</span><br><span class="line">		Diff: fromDescriptor(ocidesc),</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以看到上面的 gRPC <strong>实现服务层</strong> Local 调用 Apply 和 Diff , 最终会调用底层 diffPlugin 类实例化的两个属性值对象： walking.walkingDiff   和  apply.fsApplier ，下面将一一分解分析。</p>
<h2 id="Comparer-接口和-walking-实现"><a href="#Comparer-接口和-walking-实现" class="headerlink" title="Comparer 接口和 walking 实现"></a>Comparer 接口和 walking 实现</h2><p>Diff 的差异比对器的相关接口与结构定义</p>
<p>diff&#x2F;diff.go:46</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Comparer allows creation of filesystem diffs between mounts</span></span><br><span class="line"><span class="comment">// Comparer 允许创建两个挂载点的文件系统差异</span></span><br><span class="line"><span class="keyword">type</span> Comparer <span class="keyword">interface</span> &#123;</span><br><span class="line">  <span class="comment">// Compare 计算两个挂载点的不同，返回计算差异 diff 的描述符。</span></span><br><span class="line">  <span class="comment">// 参数opts (可选项):</span></span><br><span class="line">  <span class="comment">// ref 参照ID -- 可被用于定位所创建的 diff 的实际内容</span></span><br><span class="line">  <span class="comment">// media 类型 -- 用于决定所创建实际内容的格式</span></span><br><span class="line">	Compare(ctx context.Context, lower, upper []mount.Mount, opts ...Opt) (ocispec.Descriptor, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>diff&#x2F;diff.go:28</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Opt 用于配置 diff 操作，通过 func 的方式来操作 diff config</span></span><br><span class="line"><span class="keyword">type</span> Opt <span class="function"><span class="keyword">func</span><span class="params">(*Config)</span></span> <span class="type">error</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Config is used to hold parameters needed for a diff operation</span></span><br><span class="line"><span class="keyword">type</span> Config <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="comment">// 生成的 diff 层的类型如：“application/vnd.oci.image.layer.v1.tar+gzip”</span></span><br><span class="line">	MediaType <span class="type">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 内容的上传参照</span></span><br><span class="line">	<span class="comment">// 默认为随机字符串</span></span><br><span class="line">	Reference <span class="type">string</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对生成的内容应用标签</span></span><br><span class="line">	Labels <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Walking.NewWalkingDiff(cs)   返回 walkingDiff ，此类对象实现了 diff.Comparer 接口。walkingDiff store 属性为内容存储 content.Store 。 </p>
<p>diff&#x2F;walking&#x2F;differ.go:52 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewWalkingDiff</span><span class="params">(store content.Store)</span></span> diff.Comparer &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;walkingDiff&#123;</span><br><span class="line">		store: store,        <span class="comment">// 内容存储 </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 类结构定义</span></span><br><span class="line"><span class="keyword">type</span> walkingDiff <span class="keyword">struct</span> &#123;</span><br><span class="line">	store content.Store  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Compare() 基于指定的两个挂载目录创建 diff layer,并将其 diff 内容上传到内容存储库</p>
<p>walkingDiff Compare 方法实现：</p>
<ul>
<li>upper 上层为变化层挂载目录，lower 下层为基线层挂载目录，上&#x2F;下进行差异比对； </li>
<li>按照 OCI changesets layer 规范打包计算差异结果集 diff tar 并存储至content store(注意两块存储: content 和 content matedata )；</li>
<li>通过对目录路径对比、文件属性对比、文件内容字节对比来分析与计算变化类型；</li>
<li>变化类型主要包含：add 、modify 、delete 、unmodified。</li>
</ul>
<p>diff&#x2F;walking&#x2F;differ.go:60</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *walkingDiff)</span></span> Compare(ctx context.Context, lower, upper []mount.Mount, opts ...diff.Opt) (d ocispec.Descriptor, err <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 根据 opts 设置 diff 操作 Config </span></span><br><span class="line">	<span class="keyword">var</span> config diff.Config</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		<span class="keyword">if</span> err := opt(&amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> emptyDesc, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 设置默认媒体类型</span></span><br><span class="line">	<span class="keyword">if</span> config.MediaType == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		config.MediaType = ocispec.MediaTypeImageLayerGzip   <span class="comment">//压缩镜像层类型</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> isCompressed <span class="type">bool</span></span><br><span class="line">	<span class="keyword">switch</span> config.MediaType &#123;           <span class="comment">// 类型判断与 isCompressed 压缩标识</span></span><br><span class="line">	<span class="keyword">case</span> ocispec.MediaTypeImageLayer:   <span class="comment">// 非压缩镜像层类型</span></span><br><span class="line">	<span class="keyword">case</span> ocispec.MediaTypeImageLayerGzip:</span><br><span class="line">		isCompressed = <span class="literal">true</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> emptyDesc, errors.Wrapf(errdefs.ErrNotImplemented, <span class="string">&quot;unsupported diff media type: %v&quot;</span>, config.MediaType)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> ocidesc ocispec.Descriptor</span><br><span class="line">  <span class="comment">// 临时目录挂载上 和 下镜像层</span></span><br><span class="line">	<span class="keyword">if</span> err := mount.WithTempMount(ctx, lower, <span class="function"><span class="keyword">func</span><span class="params">(lowerRoot <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> mount.WithTempMount(ctx, upper, <span class="function"><span class="keyword">func</span><span class="params">(upperRoot <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> newReference <span class="type">bool</span></span><br><span class="line">			<span class="keyword">if</span> config.Reference == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">				newReference = <span class="literal">true</span></span><br><span class="line">				config.Reference = uniqueRef()   <span class="comment">// 生成 ref 唯一值 </span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取 store.Writer </span></span><br><span class="line">			cw, err := s.store.Writer(ctx,</span><br><span class="line">				content.WithRef(config.Reference),</span><br><span class="line">				content.WithDescriptor(ocispec.Descriptor&#123;</span><br><span class="line">					MediaType: config.MediaType, <span class="comment">// most contentstore implementations just ignore this</span></span><br><span class="line">				&#125;))</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to open writer&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		  <span class="comment">//...</span></span><br><span class="line">			<span class="keyword">if</span> !newReference &#123;</span><br><span class="line">				<span class="keyword">if</span> err = cw.Truncate(<span class="number">0</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 压缩类型镜像层处理写入 diff 内容数据</span></span><br><span class="line">			<span class="keyword">if</span> isCompressed &#123;</span><br><span class="line">				dgstr := digest.SHA256.Digester()     <span class="comment">// SHA256 算法摘要串生成器</span></span><br><span class="line">				<span class="keyword">var</span> compressed io.WriteCloser</span><br><span class="line">                                              <span class="comment">// 压缩 Gzip</span></span><br><span class="line">				compressed, err = compression.CompressStream(cw, compression.Gzip)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to get compressed stream&quot;</span>)</span><br><span class="line">				&#125;        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// +计算差异并写入 diff 内容数据 tar </span></span><br><span class="line">				err = archive.WriteDiff(ctx, io.MultiWriter(compressed, dgstr.Hash()), lowerRoot, upperRoot)                                   </span><br><span class="line">				compressed.Close()</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to write compressed diff&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> config.Labels == <span class="literal">nil</span> &#123;</span><br><span class="line">					config.Labels = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;</span><br><span class="line">				&#125;                                     <span class="comment">// 压缩标签，存入摘要字串</span></span><br><span class="line">				config.Labels[uncompressed] = dgstr.Digest().String()</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;    </span><br><span class="line">        <span class="comment">// 非压缩类型 tar 镜像层处理写入 diff 内容数据</span></span><br><span class="line">				<span class="keyword">if</span> err = archive.WriteDiff(ctx, cw, lowerRoot, upperRoot); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to write diff&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">// commit 标签选项的设置</span></span><br><span class="line">			<span class="keyword">var</span> commitopts []content.Opt</span><br><span class="line">			<span class="keyword">if</span> config.Labels != <span class="literal">nil</span> &#123;</span><br><span class="line">				commitopts = <span class="built_in">append</span>(commitopts, content.WithLabels(config.Labels))</span><br><span class="line">			&#125;</span><br><span class="line"> </span><br><span class="line">      <span class="comment">// 生成内容摘要值，并接交至内容元数据存储</span></span><br><span class="line">			dgst := cw.Digest()</span><br><span class="line">			<span class="keyword">if</span> err := cw.Commit(ctx, <span class="number">0</span>, dgst, commitopts...); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> !errdefs.IsAlreadyExists(err) &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to commit&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 获取 dgst 对应的内容存储 info 信息</span></span><br><span class="line">			info, err := s.store.Info(ctx, dgst)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to get info from content store&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> info.Labels == <span class="literal">nil</span> &#123;</span><br><span class="line">				info.Labels = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">			&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 内容存储 dgst 存在但无压缩标签时，设置 info 压缩标签</span></span><br><span class="line">			<span class="keyword">if</span> _, ok := info.Labels[uncompressed]; !ok &#123;</span><br><span class="line">				info.Labels[uncompressed] = config.Labels[uncompressed]</span><br><span class="line">				<span class="keyword">if</span> _, err := s.store.Update(ctx, info, <span class="string">&quot;labels.&quot;</span>+uncompressed); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;error setting uncompressed label&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 返回 diff 内容数据的描述器 Descriptor </span></span><br><span class="line">			ocidesc = ocispec.Descriptor&#123;</span><br><span class="line">				MediaType: config.MediaType,</span><br><span class="line">				Size:      info.Size,</span><br><span class="line">				Digest:    info.Digest,</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> emptyDesc, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ocidesc, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WriteDiff 计算所提供的两个目录(a&#x2F;b)的差异并写入 tar 包数据流。fs.Changes() 遍历计算差异，回调函数HandleChange为 ChangeSets 差异集 tar 打包处理逻辑, 其所生成的 tar 使用 OCI 标准规范的的文件标记用于对删除的文件表示。删除的文件基于 AUFS whiteouts 规范以 “.wh.” 作为前缀扩充命名文件。详细规范可以参考官方 <a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/layer.md">image-spec</a> 或 <a target="_blank" rel="noopener" href="https://www.jianshu.com/p/712273fd1cfd">image-spec 中文</a></p>
<p>archive&#x2F;tar.go:72</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WriteDiff</span><span class="params">(ctx context.Context, w io.Writer, a, b <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	cw := newChangeWriter(w, b)    <span class="comment">// +创建变化 writer </span></span><br><span class="line">	err := fs.Changes(ctx, a, b, cw.HandleChange)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to create diff tar stream&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> cw.Close()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>archive&#x2F;tar.go:451</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newChangeWriter</span><span class="params">(w io.Writer, source <span class="type">string</span>)</span></span> *changeWriter &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;changeWriter&#123;</span><br><span class="line">		tw:        tar.NewWriter(w),          <span class="comment">// 创建 Writer 写数据</span></span><br><span class="line">		source:    source,                    <span class="comment">// 变化目录</span></span><br><span class="line">		whiteoutT: time.Now(),</span><br><span class="line">		inodeSrc:  <span class="keyword">map</span>[<span class="type">uint64</span>]<span class="type">string</span>&#123;&#125;,</span><br><span class="line">		inodeRefs: <span class="keyword">map</span>[<span class="type">uint64</span>][]<span class="type">string</span>&#123;&#125;,</span><br><span class="line">		addedDirs: <span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#125;&#123;&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Changes 计算调用给定的变化计算函数 func 为每个变化类型进行处理。’a’ 是指基线目录和 ‘b’ 是更改的目录。变化回调按路径名排顺序调用和应用。正因此顺序，下面是情况为正确的:</p>
<ul>
<li><p>删除的目录树只为根目录创建一个更改目录已删除项。其余的更改是隐含的。</p>
</li>
<li><p>一个目录修改为文件将不会有删除子路径项的条目，通过父目录删除条目来暗指这些条目删除。</p>
</li>
</ul>
<p>隐藏目录不会被特殊处理，每个文件从基本目录中删除将显示为删除。</p>
<p>将对具有时间戳的文件进行文件内容比较可能存在被截断情况。如果正在比较的任意一个文件存在有一个零值纳秒值，将比较每个字节差异。如果两个文件具有相同的秒值但不同纳秒值如果其中一个值为零，则文件将如果内容相同，则视为未更改。这种行为是为了说明打包处理期间对时间戳截断的引起。</p>
<p> vendor&#x2F;github.com&#x2F;containerd&#x2F;continuity&#x2F;fs&#x2F;diff.go:101</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Changes</span><span class="params">(ctx context.Context, a, b <span class="type">string</span>, changeFn ChangeFunc)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> a == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">    <span class="comment">// 如果 &#x27;a&#x27; 基线目录为空，则直接以增加类型变化处理所有文件</span></span><br><span class="line">		logrus.Debugf(<span class="string">&quot;Using single walk diff for %s&quot;</span>, b)</span><br><span class="line">		<span class="keyword">return</span> addDirChanges(ctx, changeFn, b)</span><br><span class="line">    </span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> diffOptions := detectDirDiff(b, a); diffOptions != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// 有配置 diffOptions,当前版本 detectDirDiff() 直接返回 nil ,可忽略此逻辑（TODO项） </span></span><br><span class="line">		logrus.Debugf(<span class="string">&quot;Using single walk diff for %s from %s&quot;</span>, diffOptions.diffDir, a)</span><br><span class="line">		<span class="keyword">return</span> diffDirChanges(ctx, changeFn, a, diffOptions)</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 使用上/下双目录同时遍历与计算 diff </span></span><br><span class="line">	logrus.Debugf(<span class="string">&quot;Using double walk diff for %s from %s&quot;</span>, b, a)</span><br><span class="line">	<span class="keyword">return</span> doubleWalkDiff(ctx, changeFn, a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>HandleChange 处理逻辑 func ,作为 Changes 计算的输入参数，为每个改变类型进行处理。变化类型主要包含：add 、modify 、delete 、unmodified(未更改)、空。</p>
<p>针对删除类型处理方式为 whiteOut ,则对删除的文件或目录创建前缀 “.wh.”+原始名的 whiteOut 文件。其它类型将内容进行 tar 打包。</p>
<p>archive&#x2F;tar.go:462</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cw *changeWriter)</span></span> HandleChange(k fs.ChangeKind, p <span class="type">string</span>, f os.FileInfo, err <span class="type">error</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> k == fs.ChangeKindDelete &#123;</span><br><span class="line">    <span class="comment">// 变化类型为&quot;删除&quot;</span></span><br><span class="line">		whiteOutDir := filepath.Dir(p)</span><br><span class="line">		whiteOutBase := filepath.Base(p)</span><br><span class="line">    <span class="comment">// whiteOut 前缀 &quot;.wh.&quot;  +  原始文件名 </span></span><br><span class="line">		whiteOut := filepath.Join(whiteOutDir, whiteoutPrefix+whiteOutBase)</span><br><span class="line">		hdr := &amp;tar.Header&#123;</span><br><span class="line">			Typeflag:   tar.TypeReg,</span><br><span class="line">			Name:       whiteOut[<span class="number">1</span>:],   </span><br><span class="line">			Size:       <span class="number">0</span>,</span><br><span class="line">			ModTime:    cw.whiteoutT,</span><br><span class="line">			AccessTime: cw.whiteoutT,</span><br><span class="line">			ChangeTime: cw.whiteoutT,</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// whiteOut 父级目录不为 root 目录则作为修改变化类型处理 </span></span><br><span class="line">		<span class="keyword">if</span> err := cw.includeParents(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// tar 写入 whiteout Header </span></span><br><span class="line">		<span class="keyword">if</span> err := cw.tw.WriteHeader(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to write whiteout header&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;  </span><br><span class="line">    <span class="comment">// 其它变化类型</span></span><br><span class="line">		<span class="keyword">var</span> (</span><br><span class="line">			link   <span class="type">string</span></span><br><span class="line">			err    <span class="type">error</span></span><br><span class="line">			source = filepath.Join(cw.source, p)</span><br><span class="line">		)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">switch</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> f.Mode()&amp;os.ModeSocket != <span class="number">0</span>:   <span class="comment">// 忽略 sockets 文件</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span> </span><br><span class="line">		<span class="keyword">case</span> f.Mode()&amp;os.ModeSymlink != <span class="number">0</span>:  <span class="comment">// 链接文件则获取链接的目标位置</span></span><br><span class="line">			<span class="keyword">if</span> link, err = os.Readlink(source); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建一个部分填充的头，如果f为链接，将链接记录为链接目标。如果f为目录，则在名称后附加斜杠。</span></span><br><span class="line">		hdr, err := tar.FileInfoHeader(f, link)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置 header 权限与模式位</span></span><br><span class="line">		hdr.Mode = <span class="type">int64</span>(chmodTarEntry(os.FileMode(hdr.Mode)))</span><br><span class="line"></span><br><span class="line">		name := p</span><br><span class="line">		<span class="keyword">if</span> strings.HasPrefix(name, <span class="type">string</span>(filepath.Separator)) &#123;</span><br><span class="line">			name, err = filepath.Rel(<span class="type">string</span>(filepath.Separator), name)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to make path relative&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// 返回系统支持的 Name </span></span><br><span class="line">		name, err = tarName(name)  </span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;cannot canonicalize path&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// suffix with &#x27;/&#x27; for directories</span></span><br><span class="line">		<span class="keyword">if</span> f.IsDir() &amp;&amp; !strings.HasSuffix(name, <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">			name += <span class="string">&quot;/&quot;</span></span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// 设置 header Name </span></span><br><span class="line">		hdr.Name = name</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := setHeaderForSpecialDevice(hdr, name, f); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to set device headers&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 链接处理</span></span><br><span class="line">		<span class="keyword">var</span> additionalLinks []<span class="type">string</span></span><br><span class="line">		inode, isHardlink := fs.GetLinkInfo(f)</span><br><span class="line">		<span class="keyword">if</span> isHardlink &#123;</span><br><span class="line">      <span class="comment">// 硬链接</span></span><br><span class="line">			<span class="comment">// If the inode has a source, always link to it</span></span><br><span class="line">			<span class="keyword">if</span> source, ok := cw.inodeSrc[inode]; ok &#123;</span><br><span class="line">				hdr.Typeflag = tar.TypeLink</span><br><span class="line">				hdr.Linkname = source</span><br><span class="line">				hdr.Size = <span class="number">0</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> k == fs.ChangeKindUnmodified &#123;</span><br><span class="line">					cw.inodeRefs[inode] = <span class="built_in">append</span>(cw.inodeRefs[inode], name)</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">				cw.inodeSrc[inode] = name</span><br><span class="line">				additionalLinks = cw.inodeRefs[inode]</span><br><span class="line">				<span class="built_in">delete</span>(cw.inodeRefs, inode)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> k == fs.ChangeKindUnmodified &#123;</span><br><span class="line">      <span class="comment">// 无改变类型，直接返回</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// header 设置 security.capability </span></span><br><span class="line">		<span class="keyword">if</span> capability, err := getxattr(source, <span class="string">&quot;security.capability&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to get capabilities xattr&quot;</span>)</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> capability != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> hdr.PAXRecords == <span class="literal">nil</span> &#123;</span><br><span class="line">				hdr.PAXRecords = <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			hdr.PAXRecords[paxSchilyXattr+<span class="string">&quot;security.capability&quot;</span>] = <span class="type">string</span>(capability)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := cw.includeParents(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// tar 写入文件头 </span></span><br><span class="line">		<span class="keyword">if</span> err := cw.tw.WriteHeader(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to write file header&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> hdr.Typeflag == tar.TypeReg &amp;&amp; hdr.Size &gt; <span class="number">0</span> &#123;</span><br><span class="line">			file, err := open(source)   <span class="comment">// 打开文件</span></span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.Wrapf(err, <span class="string">&quot;failed to open path: %v&quot;</span>, source)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">defer</span> file.Close()</span><br><span class="line">     </span><br><span class="line">      <span class="comment">// tar 写入文件内容数据</span></span><br><span class="line">			n, err := copyBuffered(context.TODO(), cw.tw, file)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to copy&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> n != hdr.Size &#123;</span><br><span class="line">				<span class="keyword">return</span> errors.New(<span class="string">&quot;short write copying file&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 写入 tar header 附加链信息</span></span><br><span class="line">		<span class="keyword">if</span> additionalLinks != <span class="literal">nil</span> &#123;</span><br><span class="line">			source = hdr.Name</span><br><span class="line">			<span class="keyword">for</span> _, extra := <span class="keyword">range</span> additionalLinks &#123;</span><br><span class="line">				hdr.Name = extra</span><br><span class="line">				hdr.Typeflag = tar.TypeLink</span><br><span class="line">				hdr.Linkname = source</span><br><span class="line">				hdr.Size = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> err := cw.includeParents(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> err := cw.tw.WriteHeader(hdr); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> errors.Wrap(err, <span class="string">&quot;failed to write file header&quot;</span>)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>addDirChanges</strong>  直接以 “ add “ 增加类型变化处理所有文件</p>
<p>vendor&#x2F;github.com&#x2F;containerd&#x2F;continuity&#x2F;fs&#x2F;diff.go:114</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">addDirChanges</span><span class="params">(ctx context.Context, changeFn ChangeFunc, root <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> filepath.Walk(root, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="type">string</span>, f os.FileInfo, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Rebase path</span></span><br><span class="line">		path, err = filepath.Rel(root, path)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		path = filepath.Join(<span class="type">string</span>(os.PathSeparator), path)</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Skip root</span></span><br><span class="line">		<span class="keyword">if</span> path == <span class="type">string</span>(os.PathSeparator) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> changeFn(ChangeKindAdd, path, f, <span class="literal">nil</span>)  <span class="comment">// 增加变化类型处理</span></span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>doubleWalkDiff</strong>  遍历两个 A 、B 目录进行对比分析差异，并调用 changeFn 处理</p>
<p>vendor&#x2F;github.com&#x2F;containerd&#x2F;continuity&#x2F;fs&#x2F;diff.go:234</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// doubleWalkDiff walks both directories to create a diff</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doubleWalkDiff</span><span class="params">(ctx context.Context, changeFn ChangeFunc, a, b <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	g, ctx := errgroup.WithContext(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		c1 = <span class="built_in">make</span>(<span class="keyword">chan</span> *currentPath)</span><br><span class="line">		c2 = <span class="built_in">make</span>(<span class="keyword">chan</span> *currentPath)</span><br><span class="line"></span><br><span class="line">		f1, f2 *currentPath</span><br><span class="line">		rmdir  <span class="type">string</span></span><br><span class="line">	)</span><br><span class="line">	g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(c1)</span><br><span class="line">		<span class="keyword">return</span> pathWalk(ctx, a, c1)                   <span class="comment">// 遍历 A 目录，写入 chan C1</span></span><br><span class="line">	&#125;) </span><br><span class="line">	g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> <span class="built_in">close</span>(c2)</span><br><span class="line">		<span class="keyword">return</span> pathWalk(ctx, b, c2)                   <span class="comment">// 遍历 B 目录，写入 chan C2</span></span><br><span class="line">	&#125;)</span><br><span class="line">	g.Go(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> c1 != <span class="literal">nil</span> || c2 != <span class="literal">nil</span> &#123;      <span class="comment">//循环比对</span></span><br><span class="line">			<span class="keyword">if</span> f1 == <span class="literal">nil</span> &amp;&amp; c1 != <span class="literal">nil</span> &#123;</span><br><span class="line">				f1, err = nextPath(ctx, c1)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> f1 == <span class="literal">nil</span> &#123;</span><br><span class="line">					c1 = <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> f2 == <span class="literal">nil</span> &amp;&amp; c2 != <span class="literal">nil</span> &#123;</span><br><span class="line">				f2, err = nextPath(ctx, c2)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> f2 == <span class="literal">nil</span> &#123;</span><br><span class="line">					c2 = <span class="literal">nil</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> f1 == <span class="literal">nil</span> &amp;&amp; f2 == <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">var</span> f os.FileInfo</span><br><span class="line">			k, p := pathChange(f1, f2)   <span class="comment">// +计算路径并返回变化类型</span></span><br><span class="line">			<span class="keyword">switch</span> k &#123;</span><br><span class="line">			<span class="keyword">case</span> ChangeKindAdd: <span class="comment">// 增加变化类型</span></span><br><span class="line">				<span class="keyword">if</span> rmdir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">					rmdir = <span class="string">&quot;&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">				f = f2.f    </span><br><span class="line">				f2 = <span class="literal">nil</span></span><br><span class="line">			<span class="keyword">case</span> ChangeKindDelete:<span class="comment">// 删除变化类型 </span></span><br><span class="line">				<span class="keyword">if</span> rmdir != <span class="string">&quot;&quot;</span> &amp;&amp; strings.HasPrefix(f1.path, rmdir) &#123;</span><br><span class="line">					f1 = <span class="literal">nil</span></span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> f1.f.IsDir() &#123;                      <span class="comment">// 如果是目录则赋值 rmdir </span></span><br><span class="line">					rmdir = f1.path + <span class="type">string</span>(os.PathSeparator)</span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> rmdir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">					rmdir = <span class="string">&quot;&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">				f1 = <span class="literal">nil</span></span><br><span class="line">			<span class="keyword">case</span> ChangeKindModify:   <span class="comment">// 修改变化类型 </span></span><br><span class="line">				same, err := sameFile(f1, f2)                 <span class="comment">// 计算两者文件是否有修改</span></span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> err</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> f1.f.IsDir() &amp;&amp; !f2.f.IsDir() &#123;            <span class="comment">// 如果文件修改为目录，删除目录</span></span><br><span class="line">					rmdir = f1.path + <span class="type">string</span>(os.PathSeparator)  </span><br><span class="line">				&#125; <span class="keyword">else</span> <span class="keyword">if</span> rmdir != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">					rmdir = <span class="string">&quot;&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">				f = f2.f</span><br><span class="line">				f1 = <span class="literal">nil</span></span><br><span class="line">				f2 = <span class="literal">nil</span></span><br><span class="line">				<span class="keyword">if</span> same &#123;                                    <span class="comment">// 一致则为 Unmodified 未修改变化类型</span></span><br><span class="line">					<span class="keyword">if</span> !isLinked(f) &#123;</span><br><span class="line">						<span class="keyword">continue</span></span><br><span class="line">					&#125;</span><br><span class="line">					k = ChangeKindUnmodified</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">      <span class="comment">// 调用 changeFn 处理变化</span></span><br><span class="line">			<span class="keyword">if</span> err := changeFn(k, p, f, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> g.Wait() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pathChange() 计算路径是否改变</p>
<p>vendor&#x2F;github.com&#x2F;containerd&#x2F;continuity&#x2F;fs&#x2F;path.go:39 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">pathChange</span><span class="params">(lower, upper *currentPath)</span></span> (ChangeKind, <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="comment">// lower 不存在， upper 存在，则为 ADD 增加类型变化</span></span><br><span class="line">  <span class="keyword">if</span> lower == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> upper == <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="built_in">panic</span>(<span class="string">&quot;cannot compare nil paths&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ChangeKindAdd, upper.path</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 上面反之则为 Delete 删除类型变化</span></span><br><span class="line">	<span class="keyword">if</span> upper == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ChangeKindDelete, lower.path</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 都存在的两者目录的路径长度大小比较或路径字符大小逐一比较</span></span><br><span class="line">	<span class="keyword">switch</span> i := directoryCompare(lower.path, upper.path); &#123;</span><br><span class="line">	<span class="keyword">case</span> i &lt; <span class="number">0</span>:</span><br><span class="line">    <span class="comment">// upper 不存在，lower 存在 </span></span><br><span class="line">		<span class="keyword">return</span> ChangeKindDelete, lower.path</span><br><span class="line">	<span class="keyword">case</span> i &gt; <span class="number">0</span>:</span><br><span class="line">    <span class="comment">// upper 存在，lower 不存在 </span></span><br><span class="line">		<span class="keyword">return</span> ChangeKindAdd, upper.path</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">    <span class="comment">// 默认</span></span><br><span class="line">		<span class="keyword">return</span> ChangeKindModify, upper.path</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">directoryCompare</span><span class="params">(a, b <span class="type">string</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	l := <span class="built_in">len</span>(a)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(b) &lt; l &#123;</span><br><span class="line">		l = <span class="built_in">len</span>(b)</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 路径字符逐一比较</span></span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; l; i++ &#123;</span><br><span class="line">		c1, c2 := a[i], b[i]</span><br><span class="line">		<span class="keyword">if</span> c1 == filepath.Separator &#123;</span><br><span class="line">			c1 = <span class="type">byte</span>(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> c2 == filepath.Separator &#123;</span><br><span class="line">			c2 = <span class="type">byte</span>(<span class="number">0</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> c1 &lt; c2 &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> c1 &gt; c2 &#123;</span><br><span class="line">			<span class="keyword">return</span> +<span class="number">1</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 路径字符长度比较 </span></span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(a) &lt; <span class="built_in">len</span>(b) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(a) &gt; <span class="built_in">len</span>(b) &#123;</span><br><span class="line">		<span class="keyword">return</span> +<span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sameFile 计算文件是否被修改。</p>
<p>vendor&#x2F;github.com&#x2F;containerd&#x2F;continuity&#x2F;fs&#x2F;path.go:91 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sameFile</span><span class="params">(f1, f2 *currentPath)</span></span> (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="comment">// fileStat 比较是否一致</span></span><br><span class="line">	<span class="keyword">if</span> os.SameFile(f1.f, f2.f) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 系统 Stat 是否一致</span></span><br><span class="line">	equalStat, err := compareSysStat(f1.f.Sys(), f2.f.Sys())</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || !equalStat &#123;</span><br><span class="line">		<span class="keyword">return</span> equalStat, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// security.capability 是否一致</span></span><br><span class="line">	<span class="keyword">if</span> eq, err := compareCapabilities(f1.fullPath, f2.fullPath); err != <span class="literal">nil</span> || !eq &#123;</span><br><span class="line">		<span class="keyword">return</span> eq, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果不是目录检测文件大小、修改时间、和内容</span></span><br><span class="line">	<span class="keyword">if</span> !f1.f.IsDir() &#123;</span><br><span class="line">		<span class="keyword">if</span> f1.f.Size() != f2.f.Size() &#123; <span class="comment">// 文件大小</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">		t1 := f1.f.ModTime()</span><br><span class="line">		t2 := f2.f.ModTime()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> t1.Unix() != t2.Unix() &#123;   <span class="comment">// 修改时间比对</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 纳秒值存在截断情况，进一步检测两者内容差异</span></span><br><span class="line">		<span class="keyword">if</span> t1.Nanosecond() == <span class="number">0</span> &amp;&amp; t2.Nanosecond() == <span class="number">0</span> &#123;</span><br><span class="line">			<span class="keyword">var</span> eq <span class="type">bool</span></span><br><span class="line">      <span class="comment">// 链接类型比对链接目录是否一致</span></span><br><span class="line">			<span class="keyword">if</span> (f1.f.Mode() &amp; os.ModeSymlink) == os.ModeSymlink &#123;</span><br><span class="line">				eq, err = compareSymlinkTarget(f1.fullPath, f2.fullPath)</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> f1.f.Size() &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// 比对文件内容，两个文件内容每个字节进行对比是否存在差异</span></span><br><span class="line">				eq, err = compareFileContent(f1.fullPath, f2.fullPath)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> || !eq &#123;</span><br><span class="line">				<span class="keyword">return</span> eq, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> t1.Nanosecond() != t2.Nanosecond() &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Applier-接口和-fsApplier-应用实现"><a href="#Applier-接口和-fsApplier-应用实现" class="headerlink" title="Applier 接口和 fsApplier 应用实现"></a>Applier 接口和 fsApplier 应用实现</h2><p> Apply 将所指定描述器( ocispec.Descriptor )的参照内容应用至指定的挂载目录。 例如：通常情况下，描述器是一个 tar 格式的文件系统差异，此差异文件系统 tar 将被应用于挂载点的顶层。</p>
<p>OCI image-spec 规范对 Changesets (变化集)应用描述：</p>
<ul>
<li>媒体类型为 “application&#x2F;vnd.oci.image.layer.v1.tar” 的变化集 layer 被应用不仅仅是解包 tar 文件</li>
<li>变化集 layer 应用需要重点考虑 whiteout 文件处理</li>
<li>在无 whiteout  文件的Changesets (变化集) 如同正常 tar 文件解包</li>
</ul>
<p>应用 Changesets (变化集) 实体，如果目标路径文件已存在，则：</p>
<ul>
<li>移除文件路径</li>
<li>基于变化集实体项内容与属性，重建文件路径</li>
</ul>
<p>Applier 接口定义如下：</p>
<p>diff&#x2F;diff.go:65</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Applier <span class="keyword">interface</span> &#123;</span><br><span class="line">	Apply(ctx context.Context, desc ocispec.Descriptor, mount []mount.Mount, opts ...ApplyOpt) (ocispec.Descriptor, <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fsApplier 是 Applier 接口的实现类，定义与对象构造如下，注意唯一参数 content.Provider 内容读取器</p>
<p>diff&#x2F;apply&#x2F;apply.go:37</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewFileSystemApplier</span><span class="params">(cs content.Provider)</span></span> diff.Applier &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;fsApplier&#123;</span><br><span class="line">		store: cs,              <span class="comment">// 内容读取器</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> fsApplier <span class="keyword">struct</span> &#123;</span><br><span class="line">	store content.Provider       </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>fsApplier.Apply 实现  Applier 接口的 Apply 方法。Apply 将所指定摘要值关联的内容应用至指定的挂载目录，打包文件将被解包或解压缩释放。  </p>
<p>diff&#x2F;apply&#x2F;apply.go:52</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *fsApplier)</span></span> Apply(ctx context.Context, desc ocispec.Descriptor, mounts []mount.Mount, opts ...diff.ApplyOpt) (d ocispec.Descriptor, err <span class="type">error</span>) &#123;</span><br><span class="line">	t1 := time.Now()</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">// apply 操作 opts 配置</span></span><br><span class="line">	<span class="keyword">var</span> config diff.ApplyConfig</span><br><span class="line">	<span class="keyword">for</span> _, o := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		<span class="keyword">if</span> err := o(ctx, desc, &amp;config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> emptyDesc, errors.Wrap(err, <span class="string">&quot;failed to apply config opt&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基于指定的 desc 描述符读取 content 内容 </span></span><br><span class="line">	ra, err := s.store.ReaderAt(ctx, desc)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> emptyDesc, errors.Wrap(err, <span class="string">&quot;failed to get reader from content store&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> ra.Close()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> processors []diff.StreamProcessor</span><br><span class="line">  <span class="comment">// 创建内容处理器</span></span><br><span class="line">	processor := diff.NewProcessorChain(desc.MediaType, content.NewReader(ra))</span><br><span class="line">	processors = <span class="built_in">append</span>(processors, processor)</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// 获取 config 指定的类型内容处理器</span></span><br><span class="line">		<span class="keyword">if</span> processor, err = diff.GetProcessor(ctx, processor, config.ProcessorPayloads); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> emptyDesc, errors.Wrapf(err, <span class="string">&quot;failed to get stream processor for %s&quot;</span>, desc.MediaType)</span><br><span class="line">		&#125;</span><br><span class="line">		processors = <span class="built_in">append</span>(processors, processor)</span><br><span class="line">		<span class="keyword">if</span> processor.MediaType() == ocispec.MediaTypeImageLayer &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> processor.Close()</span><br><span class="line">  <span class="comment">// 创建摘要生成器</span></span><br><span class="line">	digester := digest.Canonical.Digester()</span><br><span class="line">  <span class="comment">// 从 processor 读写入至 digester.Hash() ，返回 reader；</span></span><br><span class="line">  <span class="comment">// readCounter 包含读取器对象和读取大小统计</span></span><br><span class="line">	rc := &amp;readCounter&#123;</span><br><span class="line">		r: io.TeeReader(processor, digester.Hash()),</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// +将内容应用至挂载目录上 </span></span><br><span class="line">	<span class="keyword">if</span> err := apply(ctx, mounts, rc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> emptyDesc, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Read any trailing data</span></span><br><span class="line">	<span class="keyword">if</span> _, err := io.Copy(ioutil.Discard, rc); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> emptyDesc, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, p := <span class="keyword">range</span> processors &#123;</span><br><span class="line">		<span class="keyword">if</span> ep, ok := p.(<span class="keyword">interface</span> &#123;</span><br><span class="line">			Err() <span class="type">error</span></span><br><span class="line">		&#125;); ok &#123;</span><br><span class="line">			<span class="keyword">if</span> err := ep.Err(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> emptyDesc, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 返回镜像层的 Descriptor</span></span><br><span class="line">	<span class="keyword">return</span> ocispec.Descriptor&#123;</span><br><span class="line">		MediaType: ocispec.MediaTypeImageLayer,</span><br><span class="line">		Size:      rc.c,</span><br><span class="line">		Digest:    digester.Digest(),</span><br><span class="line">	&#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处理关注于 linux 系统版本和 aufs 挂载文件系统方式 apply 实现逻辑。此处 aufs 联合文件系统基础知识可以<a target="_blank" rel="noopener" href="https://arkingc.github.io/2017/04/13/2017-04-13-docker-filesystem-aufs/">参考</a></p>
<p>diff&#x2F;apply&#x2F;apply_linux.go:32</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">apply</span><span class="params">(ctx context.Context, mounts []mount.Mount, r io.Reader)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">switch</span> &#123;</span><br><span class="line">   <span class="comment">// overlay 文件系统； mounts 长度为1</span></span><br><span class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(mounts) == <span class="number">1</span> &amp;&amp; mounts[<span class="number">0</span>].Type == <span class="string">&quot;overlay&quot;</span>:</span><br><span class="line">		path, parents, err := getOverlayPath(mounts[<span class="number">0</span>].Options)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> errdefs.IsInvalidArgument(err) &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		opts := []archive.ApplyOpt&#123;</span><br><span class="line">			archive.WithConvertWhiteout(archive.OverlayConvertWhiteout),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parents) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			opts = <span class="built_in">append</span>(opts, archive.WithParents(parents))</span><br><span class="line">		&#125;</span><br><span class="line">		_, err = archive.Apply(ctx, path, r, opts...)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">  <span class="comment">// aufs 文件系统；mounts 长度为1</span></span><br><span class="line">	<span class="keyword">case</span> <span class="built_in">len</span>(mounts) == <span class="number">1</span> &amp;&amp; mounts[<span class="number">0</span>].Type == <span class="string">&quot;aufs&quot;</span>:</span><br><span class="line">    <span class="comment">// 返回 mounts 的(上层 path )读写层和(下层 parents )只读层</span></span><br><span class="line">		path, parents, err := getAufsPath(mounts[<span class="number">0</span>].Options)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> errdefs.IsInvalidArgument(err) &#123;</span><br><span class="line">				<span class="keyword">break</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// 转化 whiteout 文件配置处理 func </span></span><br><span class="line">		opts := []archive.ApplyOpt&#123;</span><br><span class="line">			archive.WithConvertWhiteout(archive.AufsConvertWhiteout),</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(parents) &gt; <span class="number">0</span> &#123;</span><br><span class="line">			opts = <span class="built_in">append</span>(opts, archive.WithParents(parents))</span><br><span class="line">		&#125;</span><br><span class="line">    <span class="comment">// +diff tar 数据流应用至一个目录</span></span><br><span class="line">		_, err = archive.Apply(ctx, path, r, opts...)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// +other </span></span><br><span class="line">	<span class="keyword">return</span> mount.WithTempMount(ctx, mounts, <span class="function"><span class="keyword">func</span><span class="params">(root <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		_, err := archive.Apply(ctx, root, r)</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用 OCI 规范的 diff  tar 数据流, OCI 规范变化集应用详情可参考<a target="_blank" rel="noopener" href="https://github.com/opencontainers/image-spec/blob/master/layer.md#applying-changesets">applying-changesets</a></p>
<p>archive&#x2F;tar.go:101</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Apply applies a tar stream of an OCI style diff tar.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Apply</span><span class="params">(ctx context.Context, root <span class="type">string</span>, r io.Reader, opts ...ApplyOpt)</span></span> (<span class="type">int64</span>, <span class="type">error</span>) &#123;</span><br><span class="line">	root = filepath.Clean(root)</span><br><span class="line">  <span class="comment">// 应用选项配置</span></span><br><span class="line">	<span class="keyword">var</span> options ApplyOptions</span><br><span class="line">	<span class="keyword">for</span> _, opt := <span class="keyword">range</span> opts &#123;</span><br><span class="line">		<span class="keyword">if</span> err := opt(&amp;options); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.Wrap(err, <span class="string">&quot;failed to apply option&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> options.Filter == <span class="literal">nil</span> &#123;</span><br><span class="line">		options.Filter = all</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> options.applyFunc == <span class="literal">nil</span> &#123;</span><br><span class="line">		options.applyFunc = applyNaive   <span class="comment">// 应用操作 func  </span></span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// +调用 applyFunc 为 applyNaive() </span></span><br><span class="line">	<span class="keyword">return</span> options.applyFunc(ctx, root, tar.NewReader(r), options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>applyNaive 为原生 diff Apply 实现处理逻辑，将 OCI 规范 diff tar 数据流应用至一个目录上。 主要对  whiteout 文件进行删除处理 ，对其它文件进行 tar 解包并更新属性。</p>
<p>archive&#x2F;tar.go:123</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">applyNaive</span><span class="params">(ctx context.Context, root <span class="type">string</span>, tr *tar.Reader, options ApplyOptions)</span></span> (size <span class="type">int64</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		dirs []*tar.Header</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Used for handling opaque directory markers which</span></span><br><span class="line">		<span class="comment">// may occur out of order</span></span><br><span class="line">		unpackedPaths = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line">		convertWhiteout = options.ConvertWhiteout</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当为nil时, 定义 Whiteout 转化 func 实现</span></span><br><span class="line">	<span class="keyword">if</span> convertWhiteout == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// convertWhiteout func , 通过删除目标文件作为 whiteouts 处理</span></span><br><span class="line">		convertWhiteout = <span class="function"><span class="keyword">func</span><span class="params">(hdr *tar.Header, path <span class="type">string</span>)</span></span> (<span class="type">bool</span>, <span class="type">error</span>) &#123;</span><br><span class="line">			base := filepath.Base(path)</span><br><span class="line">			dir := filepath.Dir(path)</span><br><span class="line">      <span class="comment">// 匹配 &quot;.wh..wh..opq&quot; ,处理隐式 whitout 目录</span></span><br><span class="line">			<span class="keyword">if</span> base == whiteoutOpaqueDir &#123;</span><br><span class="line">				_, err := os.Lstat(dir)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">				&#125;</span><br><span class="line">				err = filepath.Walk(dir, <span class="function"><span class="keyword">func</span><span class="params">(path <span class="type">string</span>, info os.FileInfo, err <span class="type">error</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">if</span> os.IsNotExist(err) &#123;</span><br><span class="line">							err = <span class="literal">nil</span> <span class="comment">// parent was deleted</span></span><br><span class="line">						&#125;</span><br><span class="line">						<span class="keyword">return</span> err</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> path == dir &#123;</span><br><span class="line">						<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">if</span> _, exists := unpackedPaths[path]; !exists &#123;</span><br><span class="line">						err := os.RemoveAll(path)   <span class="comment">// 删除操作</span></span><br><span class="line">						<span class="keyword">return</span> err</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">				&#125;)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 匹配前缀 &#x27; .wh.* &#x27; </span></span><br><span class="line">			<span class="keyword">if</span> strings.HasPrefix(base, whiteoutPrefix) &#123;</span><br><span class="line">				originalBase := base[<span class="built_in">len</span>(whiteoutPrefix):]</span><br><span class="line">				originalPath := filepath.Join(dir, originalBase)</span><br><span class="line"></span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>, os.RemoveAll(originalPath)   <span class="comment">// 删除操作</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 迭代包内( tar.Reader )所有文件进行处理</span></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, ctx.Err()</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hdr, err := tr.Next()    <span class="comment">//下一个文件 </span></span><br><span class="line">	  <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Split 根目录的名称并解析符号链接。</span></span><br><span class="line">		ppath, base := filepath.Split(hdr.Name)</span><br><span class="line">		ppath, err = fs.RootPath(root, ppath)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, errors.Wrap(err, <span class="string">&quot;failed to get root path&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在连接到父路径之前连接到 root，以确保在添加到父路径之前已经基于根解析了相对链接。</span></span><br><span class="line">		path := filepath.Join(ppath, filepath.Join(<span class="string">&quot;/&quot;</span>, base))</span><br><span class="line">		<span class="keyword">if</span> path == root &#123;</span><br><span class="line">			log.G(ctx).Debugf(<span class="string">&quot;file %q ignored: resolved to root&quot;</span>, hdr.Name)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果文件不在根目录下，请确保父目录存在或已创建。</span></span><br><span class="line">		<span class="keyword">if</span> ppath != root &#123;</span><br><span class="line">			parentPath := ppath</span><br><span class="line">			<span class="keyword">if</span> base == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">				parentPath = filepath.Dir(path)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> err := mkparent(ctx, parentPath, root, options.Parents); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 原生 whiteout 转化处理 func 实现是直接移除目标文件</span></span><br><span class="line">		<span class="keyword">if</span> err := validateWhiteout(path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		writeFile, err := convertWhiteout(hdr, path)</span><br><span class="line"> 	  </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// 内容读取 reader </span></span><br><span class="line">		srcData := io.Reader(tr)</span><br><span class="line">		srcHdr := hdr</span><br><span class="line"></span><br><span class="line">    <span class="comment">// +创建 tar 文件</span></span><br><span class="line">		<span class="keyword">if</span> err := createTarFile(ctx, path, root, srcHdr, srcData); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必须在最后处理目录 mtime，以避免在其中进一步创建文件来修改目录 mtime</span></span><br><span class="line">		<span class="keyword">if</span> hdr.Typeflag == tar.TypeDir &#123;</span><br><span class="line">			dirs = <span class="built_in">append</span>(dirs, hdr)</span><br><span class="line">		&#125;</span><br><span class="line">		unpackedPaths[path] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, hdr := <span class="keyword">range</span> dirs &#123;</span><br><span class="line">		path, err := fs.RootPath(root, hdr.Name)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err := chtimes(path, boundTime(latestTime(hdr.AccessTime, hdr.ModTime)), boundTime(hdr.ModTime)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> size, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>createTarFile 创建与写入 tar 的内容文件及目录, 此方法为正常 tar 解包文件处理逻辑 </p>
<p>archive&#x2F;tar.go:288</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createTarFile</span><span class="params">(ctx context.Context, path, extractDir <span class="type">string</span>, hdr *tar.Header, reader io.Reader)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	hdrInfo := hdr.FileInfo()</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 根据文件类型创建和写入内容</span></span><br><span class="line">	<span class="keyword">switch</span> hdr.Typeflag &#123; </span><br><span class="line">	<span class="keyword">case</span> tar.TypeDir:                   <span class="comment">// Dir</span></span><br><span class="line">		<span class="comment">// Create directory unless it exists as a directory already.</span></span><br><span class="line">		<span class="comment">// In that case we just want to merge the two</span></span><br><span class="line">		<span class="keyword">if</span> fi, err := os.Lstat(path); !(err == <span class="literal">nil</span> &amp;&amp; fi.IsDir()) &#123;</span><br><span class="line">			<span class="keyword">if</span> err := mkdir(path, hdrInfo.Mode()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> tar.TypeReg, tar.TypeRegA:    <span class="comment">// Geg</span></span><br><span class="line">		file, err := openFile(path, os.O_WRONLY|os.O_CREATE|os.O_TRUNC, hdrInfo.Mode())</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		_, err = copyBuffered(ctx, file, reader)</span><br><span class="line">		<span class="keyword">if</span> err1 := file.Close(); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			err = err1</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> tar.TypeBlock, tar.TypeChar:   <span class="comment">// FIFO</span></span><br><span class="line">		<span class="comment">// Handle this is an OS-specific way</span></span><br><span class="line">		<span class="keyword">if</span> err := handleTarTypeBlockCharFifo(hdr, path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> tar.TypeFifo:                   <span class="comment">// FIFO</span></span><br><span class="line">		<span class="comment">// Handle this is an OS-specific way</span></span><br><span class="line">		<span class="keyword">if</span> err := handleTarTypeBlockCharFifo(hdr, path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">            </span><br><span class="line">	<span class="keyword">case</span> tar.TypeLink:                  <span class="comment">// Hard Link</span></span><br><span class="line">		targetPath, err := hardlinkRootPath(extractDir, hdr.Linkname)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := os.Link(targetPath, path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> tar.TypeSymlink:               <span class="comment">// Symlink </span></span><br><span class="line">		<span class="keyword">if</span> err := os.Symlink(hdr.Linkname, path); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">case</span> tar.TypeXGlobalHeader:</span><br><span class="line">		log.G(ctx).Debug(<span class="string">&quot;PAX Global Extended Headers found and ignored&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> errors.Errorf(<span class="string">&quot;unhandled tar header type %d\n&quot;</span>, hdr.Typeflag)</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">// xattr 属性设置 </span></span><br><span class="line">	<span class="keyword">for</span> key, value := <span class="keyword">range</span> hdr.PAXRecords &#123;</span><br><span class="line">		<span class="keyword">if</span> strings.HasPrefix(key, paxSchilyXattr) &#123;</span><br><span class="line">			key = key[<span class="built_in">len</span>(paxSchilyXattr):]</span><br><span class="line">			<span class="keyword">if</span> err := setxattr(path, key, value); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> errors.Cause(err) == syscall.ENOTSUP &#123;</span><br><span class="line">					log.G(ctx).WithError(err).Warnf(<span class="string">&quot;ignored xattr %s in archive&quot;</span>, key)</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// change owner 设置</span></span><br><span class="line">	<span class="keyword">if</span> err := handleLChmod(hdr, path, hdrInfo); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建时间</span></span><br><span class="line">	<span class="keyword">return</span> chtimes(path, boundTime(latestTime(hdr.AccessTime, hdr.ModTime)), boundTime(hdr.ModTime))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来看一下  mount.WithTempMount() 的实现，将所有挂载目录列表挂载到临时目录，然后将此临时目录作为传参给回调func f处理，我们可以从上面的代码了解到回调 func 内的处理也就是调用 archive.Apply() 处理，此apply 上面已详细的分析了代码逻辑。此处我们关注如何 mount 所有挂载目录的过程逻辑。</p>
<p>mount&#x2F;temp.go:33</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTempMount</span><span class="params">(ctx context.Context, mounts []Mount, f <span class="keyword">func</span>(root <span class="type">string</span>)</span></span> <span class="type">error</span>) (err <span class="type">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 生成临时目录&quot;/containerd-mount&quot;</span></span><br><span class="line">	root, uerr := ioutil.TempDir(tempMountLocation, <span class="string">&quot;containerd-mount&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> uerr != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.Wrapf(uerr, <span class="string">&quot;failed to create temp dir&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">  <span class="comment">// 挂载所有到上面创建的临时目录</span></span><br><span class="line">	<span class="keyword">if</span> uerr = All(mounts, root); uerr != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.Wrapf(uerr, <span class="string">&quot;failed to mount %s&quot;</span>, root)</span><br><span class="line">	&#125;</span><br><span class="line">  <span class="comment">// 回调func f ,传参为挂载后的目录</span></span><br><span class="line">	<span class="keyword">return</span> errors.Wrapf(f(root), <span class="string">&quot;mount callback failed on %s&quot;</span>, root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>All() 遍历挂载所有 mount 到指定的目标目录</p>
<p>mount&#x2F;mount.go:33</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">All</span><span class="params">(mounts []Mount, target <span class="type">string</span>)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, m := <span class="keyword">range</span> mounts &#123;       </span><br><span class="line">		<span class="keyword">if</span> err := m.Mount(target); err != <span class="literal">nil</span> &#123;   <span class="comment">// +遍历挂载</span></span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mount.Mount() 为 linux OS 底层对 mount 的调用实现 ，调用 unix.Mount() 来完成挂载操作。 </p>
<p>mount&#x2F;mount_linux.go:38</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mount to the provided target path</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mount)</span></span> Mount(target <span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		chdir   <span class="type">string</span></span><br><span class="line">		options = m.Options</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// avoid hitting one page limit of mount argument buffer</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> 512 is a buffer during pagesize check.</span></span><br><span class="line">	<span class="keyword">if</span> m.Type == <span class="string">&quot;overlay&quot;</span> &amp;&amp; optionsSize(options) &gt;= pagesize<span class="number">-512</span> &#123;</span><br><span class="line">		chdir, options = compactLowerdirOption(options)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	flags, data := parseMountOptions(options)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(data) &gt; pagesize &#123;</span><br><span class="line">		<span class="keyword">return</span> errors.Errorf(<span class="string">&quot;mount options is too long&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// propagation types.</span></span><br><span class="line">	<span class="keyword">const</span> ptypes = unix.MS_SHARED | unix.MS_PRIVATE | unix.MS_SLAVE | unix.MS_UNBINDABLE</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Ensure propagation type change flags aren&#x27;t included in other calls.</span></span><br><span class="line">	oflags := flags &amp;^ ptypes</span><br><span class="line"></span><br><span class="line">	<span class="comment">// In the case of remounting with changed data (data != &quot;&quot;), need to call mount (moby/moby#34077).</span></span><br><span class="line">	<span class="keyword">if</span> flags&amp;unix.MS_REMOUNT == <span class="number">0</span> || data != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		<span class="comment">// Initial call applying all non-propagation flags for mount</span></span><br><span class="line">		<span class="comment">// or remount with changed data</span></span><br><span class="line">		<span class="keyword">if</span> err := mountAt(chdir, m.Source, target, m.Type, <span class="type">uintptr</span>(oflags), data); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> flags&amp;ptypes != <span class="number">0</span> &#123;</span><br><span class="line">		<span class="comment">// Change the propagation type.</span></span><br><span class="line">		<span class="keyword">const</span> pflags = ptypes | unix.MS_REC | unix.MS_SILENT</span><br><span class="line">		<span class="keyword">if</span> err := unix.Mount(<span class="string">&quot;&quot;</span>, target, <span class="string">&quot;&quot;</span>, <span class="type">uintptr</span>(flags&amp;pflags), <span class="string">&quot;&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> broflags = unix.MS_BIND | unix.MS_RDONLY</span><br><span class="line">	<span class="keyword">if</span> oflags&amp;broflags == broflags &#123;</span><br><span class="line">		<span class="comment">// Remount the bind to apply read only.</span></span><br><span class="line">		<span class="keyword">return</span> unix.Mount(<span class="string">&quot;&quot;</span>, target, <span class="string">&quot;&quot;</span>, <span class="type">uintptr</span>(oflags|unix.MS_REMOUNT), <span class="string">&quot;&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前面已解析了 diff 服务( diff &#x2F; apply )的底层实现代码逻辑，我们再来看看上层的对 diff 应用实例的分析，加深对 diff 的应用场景的理解。下面给出了对 contained  cli 工具 ctr 命令 snapshot diff 的代码分析。 </p>
<h2 id="Snapshot-diff-应用"><a href="#Snapshot-diff-应用" class="headerlink" title="Snapshot diff 应用"></a>Snapshot diff 应用</h2><p>ctr 工具的 snapshot diff 命令实现逻辑 </p>
<p>cmd&#x2F;ctr&#x2F;commands&#x2F;snapshots&#x2F;snapshots.go:112 </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">	Action: <span class="function"><span class="keyword">func</span><span class="params">(context *cli.Context)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">		<span class="keyword">var</span> (</span><br><span class="line">			idA = context.Args().First()</span><br><span class="line">			idB = context.Args().Get(<span class="number">1</span>)</span><br><span class="line">		)</span><br><span class="line">		<span class="keyword">if</span> idA == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> errors.New(<span class="string">&quot;snapshot id must be provided&quot;</span>)</span><br><span class="line">		&#125;</span><br><span class="line">		client, ctx, cancel, err := commands.NewClient(context)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">		ctx, done, err := client.WithLease(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> done(ctx)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> desc ocispec.Descriptor</span><br><span class="line">		labels := commands.LabelArgs(context.StringSlice(<span class="string">&quot;label&quot;</span>))</span><br><span class="line">		snapshotter := client.SnapshotService(context.GlobalString(<span class="string">&quot;snapshotter&quot;</span>))</span><br><span class="line"></span><br><span class="line">		fmt.Println(context.String(<span class="string">&quot;media-type&quot;</span>))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> context.Bool(<span class="string">&quot;keep&quot;</span>) &#123;</span><br><span class="line">			labels[<span class="string">&quot;containerd.io/gc.root&quot;</span>] = time.Now().UTC().Format(time.RFC3339)</span><br><span class="line">		&#125;</span><br><span class="line">		opts := []diff.Opt&#123;</span><br><span class="line">			diff.WithMediaType(context.String(<span class="string">&quot;media-type&quot;</span>)),</span><br><span class="line">			diff.WithReference(context.String(<span class="string">&quot;ref&quot;</span>)),</span><br><span class="line">			diff.WithLabels(labels),</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> idB == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">      <span class="comment">//  未指定参数 idB 则 CreateDiff 以“父”为比较对象求两者差异</span></span><br><span class="line">			desc, err = rootfs.CreateDiff(ctx, idA, snapshotter, client.DiffService(), opts...)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;     <span class="comment">// 指定参数 idB 则 Compare</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 挂载快照 </span></span><br><span class="line">			desc, err = withMounts(ctx, idA, snapshotter, <span class="function"><span class="keyword">func</span><span class="params">(a []mount.Mount)</span></span> (ocispec.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">				<span class="keyword">return</span> withMounts(ctx, idB, snapshotter, <span class="function"><span class="keyword">func</span><span class="params">(b []mount.Mount)</span></span> (ocispec.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">          <span class="comment">// DiffService Compare 调用进行比较 A/B 差异，返回 Descriptor </span></span><br><span class="line">					<span class="keyword">return</span> client.DiffService().Compare(ctx, a, b, opts...)</span><br><span class="line">				&#125;)</span><br><span class="line">			&#125;)</span><br><span class="line">      </span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125; </span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 从内容存储库读取 desc 内容</span></span><br><span class="line">		ra, err := client.ContentStore().ReaderAt(ctx, desc)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 标准输出内容</span></span><br><span class="line">		_, err = io.Copy(os.Stdout, content.NewReader(ra))</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>rootfs.Creatediff() 从给定的快照的“父”与自身两者比较创建layer diff(镜像层差异)。</p>
<p>提供内容引用以跟踪内容创建的进度，提供的快照程序和挂载差异用于差异的计算，最后将返回layer diff(镜像层差异)的描述符。</p>
<p>rootfs&#x2F;diff.go:32</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateDiff</span><span class="params">(ctx context.Context, snapshotID <span class="type">string</span>, sn snapshots.Snapshotter, d diff.Comparer, opts ...diff.Opt)</span></span> (ocispec.Descriptor, <span class="type">error</span>) &#123;</span><br><span class="line">	info, err := sn.Stat(ctx, snapshotID)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ocispec.Descriptor&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	lowerKey := fmt.Sprintf(<span class="string">&quot;%s-parent-view&quot;</span>, info.Parent)   <span class="comment">// 指定的“父” key 引用</span></span><br><span class="line">	lower, err := sn.View(ctx, lowerKey, info.Parent)        <span class="comment">// snapshotter.View </span></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> ocispec.Descriptor&#123;&#125;, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> sn.Remove(ctx, lowerKey)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> upper []mount.Mount</span><br><span class="line">	<span class="keyword">if</span> info.Kind == snapshots.KindActive &#123;</span><br><span class="line">		upper, err = sn.Mounts(ctx, snapshotID)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ocispec.Descriptor&#123;&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		upperKey := fmt.Sprintf(<span class="string">&quot;%s-view&quot;</span>, snapshotID)   <span class="comment">// 指定的 snapshot 引用</span></span><br><span class="line">		upper, err = sn.View(ctx, upperKey, snapshotID)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> ocispec.Descriptor&#123;&#125;, err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">defer</span> sn.Remove(ctx, upperKey)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> d.Compare(ctx, lower, upper, opts...)      <span class="comment">// 比较两者差异并返回 layer diff Descriptor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>~~ <strong>本文 END</strong> ~~</p>


<div class="article-footer reveal fs14"><section id="license"><div class="header"><span>许可协议</span></div><div class="body"><p>本文采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">署名-非商业性使用-相同方式共享 4.0 国际</a> 许可协议，转载请注明出处。</p>
</div></section></div>

</article>

<div class="related-wrap reveal" id="read-next"><section class="body"><div class="item" id="prev"><div class="note">较新文章</div><a href="/2023/01/17/Containerd_Image/">Containerd Image 服务</a></div><div class="item" id="next"><div class="note">较早文章</div><a href="/2023/01/16/Containerd_Content/">Containerd Content 服务</a></div></section></div>






  <div class='related-wrap md-text reveal' id="comments">
    <section class='header cmt-title cap theme'>
      快来参与讨论吧
    </section>
    <section class='body cmt-body artalk'>
      

<div id="artalk_container"><svg class="loading" style="vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2709"><path d="M832 512c0-176-144-320-320-320V128c211.2 0 384 172.8 384 384h-64zM192 512c0 176 144 320 320 320v64C300.8 896 128 723.2 128 512h64z" p-id="2710"></path></svg></div>
    </section>
  </div>



      
<footer class="page-footer reveal fs12"><hr><div class="text"><p>个人技术分享 |  经验总结 |  技术实践  |  心情<br>XiaoYang   <a href="mailto:&#115;&#117;&#x70;&#x65;&#114;&#115;&#x70;&#x6a;&#x6a;&#x40;&#x31;&#54;&#51;&#x2e;&#99;&#x6f;&#x6d;">&#115;&#117;&#x70;&#x65;&#114;&#115;&#x70;&#x6a;&#x6a;&#x40;&#x31;&#54;&#51;&#x2e;&#99;&#x6f;&#x6d;</a>          </p>
</div></footer>

      <div class='float-panel mobile-only blur' style='display:none'>
  <button type='button' class='sidebar-toggle mobile' onclick='sidebar.toggle()'>
    <svg class="icon" style="width: 1em; height: 1em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15301"><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 2.3 26.8 24.6 47.5 51.6 47.6h416.5v4z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15302"></path><path d="M566.407 808.3c26.9-0.1 49.3-20.8 51.6-47.6-1.9-27.7-23.9-49.7-51.6-51.6h-412.6c-28.2-1.4-52.6 19.5-55.5 47.6 1.9 27.7 23.9 49.7 51.6 51.6h416.5z m309.3-249.9c26.9-0.1 49.3-20.8 51.6-47.6-2.2-26.8-24.6-47.5-51.6-47.6h-721.9c-27.7-2.8-52.5 17.4-55.3 45.1-0.1 0.8-0.1 1.7-0.2 2.5 0.9 27.2 23.6 48.5 50.7 47.6H875.707z m-103.1-245.9c26.9-0.1 49.3-20.8 51.6-47.6-0.4-28.3-23.2-51.1-51.5-51.6h-618.9c-29.5-1.1-54.3 21.9-55.5 51.4v0.2c1.4 27.8 25.2 49.2 53 47.8 0.8 0 1.7-0.1 2.5-0.2h618.8z" p-id="15303"></path></svg>
  </button>
</div>

    </div>
  </div>
  <div class='scripts'>
    <script type="text/javascript">
  const stellar = {
    // 懒加载 css https://github.com/filamentgroup/loadCSS
    loadCSS: (href, before, media, attributes) => {
      var doc = window.document;
      var ss = doc.createElement("link");
      var ref;
      if (before) {
        ref = before;
      } else {
        var refs = (doc.body || doc.getElementsByTagName("head")[0]).childNodes;
        ref = refs[refs.length - 1];
      }
      var sheets = doc.styleSheets;
      if (attributes) {
        for (var attributeName in attributes) {
          if (attributes.hasOwnProperty(attributeName)) {
            ss.setAttribute(attributeName, attributes[attributeName]);
          }
        }
      }
      ss.rel = "stylesheet";
      ss.href = href;
      ss.media = "only x";
      function ready(cb) {
        if (doc.body) {
          return cb();
        }
        setTimeout(function () {
          ready(cb);
        });
      }
      ready(function () {
        ref.parentNode.insertBefore(ss, before ? ref : ref.nextSibling);
      });
      var onloadcssdefined = function (cb) {
        var resolvedHref = ss.href;
        var i = sheets.length;
        while (i--) {
          if (sheets[i].href === resolvedHref) {
            return cb();
          }
        }
        setTimeout(function () {
          onloadcssdefined(cb);
        });
      };
      function loadCB() {
        if (ss.addEventListener) {
          ss.removeEventListener("load", loadCB);
        }
        ss.media = media || "all";
      }
      if (ss.addEventListener) {
        ss.addEventListener("load", loadCB);
      }
      ss.onloadcssdefined = onloadcssdefined;
      onloadcssdefined(loadCB);
      return ss;
    },

    // 从 butterfly 和 volantis 获得灵感
    loadScript: (src, opt) => new Promise((resolve, reject) => {
      var script = document.createElement('script');
      script.src = src;
      if (opt) {
        for (let key of Object.keys(opt)) {
          script[key] = opt[key]
        }
      } else {
        // 默认异步，如果需要同步，第二个参数传入 {} 即可
        script.async = true
      }
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    }),

    // https://github.com/jerryc127/hexo-theme-butterfly
    jQuery: (fn) => {
      if (typeof jQuery === 'undefined') {
        stellar.loadScript(stellar.plugins.jQuery).then(fn)
      } else {
        fn()
      }
    }
  };
  stellar.version = '1.18.5';
  stellar.github = 'https://github.com/xaoxuu/hexo-theme-stellar/tree/1.18.5';
  stellar.config = {
    date_suffix: {
      just: '刚刚',
      min: '分钟前',
      hour: '小时前',
      day: '天前',
      month: '个月前',
    },
  };

  // required plugins (only load if needs)
  stellar.plugins = {
    jQuery: 'https://gcore.jsdelivr.net/npm/jquery@3.6.2/dist/jquery.min.js'
  };

  if ('local_search') {
    stellar.search = {};
    stellar.search.service = 'local_search';
    if (stellar.search.service == 'local_search') {
      let service_obj = Object.assign({}, {"field":"all","path":"/search.json","content":true,"codeblock":true,"sort":"-date"});
      stellar.search[stellar.search.service] = service_obj;
    }
  }

  // stellar js
  stellar.plugins.stellar = Object.assign({"sites":"/js/plugins/sites.js","friends":"/js/plugins/friends.js","ghinfo":"/js/plugins/ghinfo.js","timeline":"/js/plugins/timeline.js","linkcard":"/js/plugins/linkcard.js","fcircle":"/js/plugins/fcircle.js","weibo":"/js/plugins/weibo.js"});

  stellar.plugins.marked = Object.assign("https://cdn.bootcdn.net/ajax/libs/marked/4.0.18/marked.min.js");
  // optional plugins
  if ('true' == 'true') {
    stellar.plugins.lazyload = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/vanilla-lazyload@17.8.3/dist/lazyload.min.js","transition":"blur"});
  }
  if ('true' == 'true') {
    stellar.plugins.swiper = Object.assign({"enable":true,"css":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.css","js":"https://unpkg.com/swiper@8.4.5/swiper-bundle.min.js"});
  }
  if ('' == 'true') {
    stellar.plugins.scrollreveal = Object.assign({"enable":null,"js":"https://gcore.jsdelivr.net/npm/scrollreveal@4.0.9/dist/scrollreveal.min.js","distance":"8px","duration":500,"interval":100,"scale":1});
  }
  if ('true' == 'true') {
    stellar.plugins.preload = Object.assign({"enable":true,"service":"flying_pages","instant_page":"https://gcore.jsdelivr.net/gh/volantis-x/cdn-volantis@4.1.2/js/instant_page.js","flying_pages":"https://gcore.jsdelivr.net/gh/gijo-varghese/flying-pages@2.1.2/flying-pages.min.js"});
  }
  if ('true' == 'true') {
    stellar.plugins.fancybox = Object.assign({"enable":true,"js":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.umd.js","css":"https://gcore.jsdelivr.net/npm/@fancyapps/ui@4.0/dist/fancybox.css","selector":".swiper-slide img"});
  }
  if ('false' == 'true') {
    stellar.plugins.heti = Object.assign({"enable":false,"css":"https://unpkg.com/heti@0.9.2/umd/heti.min.css","js":"https://unpkg.com/heti@0.9.2/umd/heti-addon.min.js"});
  }
</script>

<!-- required -->

  
<script src="/js/main.js" async></script>



<!-- optional -->

  <script>
  function load_artalk() {
    if (!document.querySelectorAll("#artalk_container")[0]) return;
    stellar.loadCSS('https://unpkg.com/artalk@2.4.3/dist/Artalk.css');
    stellar.loadScript('https://unpkg.com/artalk@2.4.3/dist/Artalk.js', {defer: true}).then(function () {
      const el = document.getElementById("artalk_container");
      var path = el.getAttribute('comment_id');
      if (!path) {
        path = decodeURI(window.location.pathname);
      }
      var artalk = new Artalk({
        el: '#artalk_container',
        pageKey: path,
        pageTitle: 'Containerd Diff 服务',
        server: '',
        placeholder: '',
        site: '知识库',
        darkMode: 'auto'
        })
      });
  }
  window.addEventListener('DOMContentLoaded', (event) => {
    load_artalk();
  });
</script>



<!-- inject -->


  </div>
</body>
</html>
